# 第一个任务：jkf 12个接口

@toc

## 1.查询厂家名【WEB】
    jkf/queryDoorLockManufacturers
    `查询 status!=0  or  status is null 的记录`ok
### 注意点

|传入     | 传出    |  remark|
| --------- | -------- | -----: |
| 无  | JSONArray--设备信息 | status--是否无效 |

### sql语句
```sql
select 
<include refid="Base_Column_List" />  
from door_lock_manufacturer_info
where status !=0 or status is null
order by manufacturer_name
```
## 2.根据厂家查询设备型号【WEB】
    jkf/queryDoorLockEquipmentModelList
### 注意点
|传入     | 传出    |  remark|
| --------- | -------- | -----: |
| 厂家id  | JSONArray--厂家信息 | status--是否无效 |
- [x] 传入厂家id为空时查不到数据
  - [x] 厂家id 有效
  - [x] 厂家id失效
# 改
### sql语句
```sql
    select 
    dl.*
    from door_lock_model dl,door_lock_manufacturer_info dm
    where dl.manufacturer_id=dm.manufacturer_id
		and (dl.status != 0 or dl.status is null)
		and  (dm.status != 0 or dm.status is null)
and manufacturer_id = #{manufacturerId,jdbcType=VARCHAR}
```
## 3. 录入智能门锁设备接口【WEB】
    jkf/insertDoorLockEquipment
### 注意点
### sql语句
  |参数名|必选|类型|字段名称
|:--|:--|:--|:--|
|manufacturerId |string |厂家id |
|lockModelId |string  |设备型号id|
|equipmentNo |string |设备 ID |
三个字段均校验
## 4. 查询设备信息列表【WEB】
    jkf/queryDoorLockEquipmentList
### 注意点
### sql语句
```sql
 select 
  de.equipment_id equipmentId,
  de.equipment_no equipmentNo,
  de.create_time typeInTime,
  dm.manufacturer_name manufacturerName,
  dl.lock_model_name lockModelName,   
  dr.out_time outTime,
  dr.bind_time bindTime,
  ( -- case when查询某个字段
  case  
  when dr.corp_id is null then '0' 
  else '1' end
  ) as outStatus,
  (case  when dr.guest_room_id is null then '0' else '1' end) as bindStatus,
  c.city_id cityId, 
  c.corp_name corpName,
  g.guest_room_name guestRoomName
  from door_lock_equipment_info de 
  left join door_lock_model dl on de.lock_model_id=dl.lock_model_id
  left join door_lock_manufacturer_info dm on dm.manufacturer_id=dl.manufacturer_id
  left join door_lock_relation dr on dr.equipment_id=de.equipment_id 
  left join corp_info c on c.corp_id=dr.corp_id
  left join guest_room_info g on g.guest_room_id=dr.guest_room_id

  where (de.status = 1 or de.status is null) and (dm.status = 1 or dm.status is null) and (dl.status = 1 or dl.status is null) and (g.status = 1 or g.status is null)
  <if test="equipmentNo != null and equipmentNo != ''">   
  and de.equipment_no like  concat('%',#{equipmentNo,jdbcType=VARCHAR},'%')
  </if>   
  <if test="manufacturerId != null and manufacturerId != ''">   
  and dm.manufacturer_id=#{manufacturerId,jdbcType=VARCHAR}
  </if>   
  <if test="lockModelId != null and lockModelId != ''">   
  and dl.lock_model_id=#{lockModelId,jdbcType=VARCHAR}
  </if>   
  <if test="outStatus == '1'.toString()">   
  and dr.corp_id is NOT NULL
      </if>   
<if test="outStatus == '0'.toString()">   
and dr.corp_id is NULL
</if>   
<if test="bindStatus == '1'.toString()">   
and dr.guest_room_id is NOT NULL
</if>   
<if test="bindStatus == '0'.toString()">   
and dr.guest_room_id is NULL
</if>   
<if test="corpId != null and corpId != ''">   
and dr.corp_id=#{corpId,jdbcType=VARCHAR}
</if>
```

   
##  5.删除设备接口【WEB】
    jkf/deleteDoorLockDevice
### 注意点
### sql语句
- [x] 逻辑删除： `status`字段改为`‘0’`
- [x] 校验传入的设备是否已绑定客房--不管前端是否绑定，后端要进行验证。-- 绑定商家若是验证的话，又要用到门锁关系表。


##  6.查询客房列表【WEB】
    jkf/queryGuestRoomListForOms

### sql语句
##  7.添加或更新门锁设备信息【WEB】
    jkf/updateDoorLockDeviceToGuestRoom
- [x] 客房是否存在？
- [x] 设备是否存在？
  - [x] 备是否绑定？
  绑定：
    - [x] g.equipment_id, is_lock-1,更新人，更新时间
    - [x] d:guest_room_id, 更新人，更新时间
  解绑：
    - [x] g.equipment_id, is_lock-0,更新人，更新时间
    - [x] d:guest_room_id, 更新人，更新时间
### 注意点
### sql语句

##  8.根据商家查询其下设备接口【WEB】
    jkf/queryDoorLockDeviceByCorp
 - [ ] 判断商家是否存在
 - [ ] 
##  9.查询客房表中位置信息【WEB】
    jkf/queryGuestRoomLocation


##  10.录入客房接口【WEB】
  jkf/insertGuestRoom
   - [x] 房间号是否存在？
   - [x] 是否传设备？
     - [x] 设备是否存在？
       - [x] 设备是否绑定？
       - [x] 设备是否属于该商家？
       - [x] 房型是否存在
## 11.查询客房列表接口【WEB】
    jkf/queryGuestRoomList
```sql
select 
		g.guest_room_id guestRoomId,
		g.guest_room_name guestRoomName,
		c.city_id cityId,
	    c.corp_name corpName,
	    c.corp_id corpId,·
	    de.equipment_no equipmentNo,
	    g.is_lock bindStatus,
	    r.name productName,
	    dr.bind_time bindTime
    from guest_room_info g 
    left join room_product_info r on g.product_id = r.product_id
    left join door_lock_relation dr on g.guest_room_id = dr.guest_room_id
    left join door_lock_equipment_info de on de.equipment_id = dr.equipment_id
    left join corp_info c on c.corp_id = r.corp_id
    where (de.status = 1 or de.status is null)
  and (g.status = 1 or g.status is null)
……
and r.corp_id=#{corpId,jdbcType=VARCHAR}
-- 原本是 dr.corp_id，以门锁关系表的字段为主，导致只筛选绑定设备的。

```
## 12.根据客房id查询订单列表接口【WEB】
    jkf/queryOrderListInGuestRoom
### 注意点
- [x] 缺省显示最近 30 天的订单
- [x] (同时返回密码）·
### sql语句
```java

```
   

* * *

## 其他知识点
实体类为返回类型
```java
RoomProductInfo selectByPrimaryKey(String productId);
```
-  实体类为返回类型，查不到数据的情况下，返回值为null：`detail.put("roomProductInfo==null",roomProductInfo==null);`    
结果是：true
- 实体类的某个字段值为null,返回结果就是null
`roomProductInfo.getTime()==null`
 结果是：true
 
返回值类型为Map
`Map<String,Object> selectDetail(String productId);`
- 没取到的值   == null
`detail.put("map",map.get("publishTime")==null);`
- 取到的值是‘’
```java
detail.put("map.vrUrl",map.get("vrUrl"));
detail.put("map.vrUrl==null",map.get("vrUrl")==null);
detail.put("map.vrUrl equals ''","".equals(map.get("vrUrl")));
结果/*
    "map.vrUrl==null": false,
    "map.vrUrl equals ''": true,
    "map.vrUrl": "",*/
```
- 取到的值是(Null)
```java
detail.put("map.vrUrl",map.get("vrUrl"));
detail.put("map.vrUrl==null",map.get("vrUrl")==null);
detail.put("map.vrUrl equals ''","".equals(map.get("vrUrl")));
结果/*
    "map.vrUrl==null": true,
    "map.vrUrl equals ''": false,
    "map.vrUrl": null,*/
```

* * *

### 代码记录
```xml
<!-- 查看设备是否已绑定客房 -->
<select id="selectIsLock" parameterType="java.lang.String" resultType="java.lang.Integer">  select
   <include refid="Base_Column_List" />  from 
 guest_room_info g,
 door_lock_equipment_info de
where
 g.equipment_id=de.equipment_id
and
 g.equipment_id=#{equipmentId,jdbcType=VARCHAR} and 
 (de.status !='0' or de.status is null)
</select>
```
```java
//查看设备是否已绑定客房 int flag = guestRoomInfoMapper.selectIsLock(equipmentId);
if(flag>0) {
  detail.put(Consts.RESULT, ErrorCode.FAILED);
   detail.put(Consts.RESULT_NOTE, "设备已绑定");
   return detail;
}
```

```java
    @Override
  public JSONObject queryDoorLockEquipmentList(JSONObject params) {
  JSONObject detail = new JSONObject();

      String isBlankResult = StringUtil.isBlank(params, "pageNo","onePageNum");
      if (!isBlankResult.equals("")) {
  detail.put(Consts.RESULT, ErrorCode.FAILED);
         detail.put(Consts.RESULT_NOTE, isBlankResult);
         return detail;
      }
  String equipmentNo = JsonUtil.getJString(params, "equipmentNo");
      String manufacturerId = JsonUtil.getJString(params, "manufacturerId");
      String lockModelId = JsonUtil.getJString(params, "lockModelId");
      String outStatus = JsonUtil.getJString(params, "outStatus");
      String bindStatus = JsonUtil.getJString(params, "bindStatus");
      int pageNo = JsonUtil.getJInt(params, "pageNo");
      int onePageNum = JsonUtil.getJInt(params, "onePageNum");

      Map<String, Object> paramMap = new HashMap<String, Object>();
      paramMap.put("equipmentNo", equipmentNo);
      paramMap.put("manufacturerId", manufacturerId);
      paramMap.put("lockModelId", lockModelId);
      paramMap.put("outStatus", outStatus);
      paramMap.put("bindStatus", bindStatus);

      PageHelper.startPage(pageNo, onePageNum);
      List<Map<String, Object>> list = doorLockEquipmentInfoMapper.selectDoorLockEquipmentList(paramMap);
      PageInfo<Map<String, Object>> page = new PageInfo<>(list);

      detail.put(Consts.PAGE_NO, page.getPageNum());
        detail.put(Consts.PAGE_AMT, page.getPages());
        detail.put(Consts.RECORD_AMT, page.getTotal());

      JSONArray dataList = new JSONArray();
        JSONObject jo = null;
        for (Map<String, Object> map : list) {
  jo = new JSONObject();
            JSONObject resultJason = JsonUtil.parseObjectToJSONObject(map);
//            jo.put("equipmentId", map.get("equipmentId")); //            jo.put("equipmentNo", map.get("equipmentNo")); //            jo.put("manufacturerName", map.get("manufacturerName")); //            jo.put("lockModelName", map.get("lockModelName"));
  jo.put("typeInTime", Utils.dateTime2Str((Date) map.get("typeInTime")));
//            jo.put("outStatus", map.get("outStatus"));
  jo.put("outTime", Utils.dateTime2Str((Date)map.get("outTime")));
            jo.put("cityName", CustomUtils.getCityNameFromRedis(map.get("cityId")));
//            jo.put("corpName", map.get("corpName")); //            jo.put("bindStatus", map.get("bindStatus"));
  jo.put("bindTime", Utils.dateTime2Str((Date)map.get("bindTime")));
//            jo.put("guestRoomName", map.get("guestRoomName"));
  JsonUtil.setResponseParams(resultJason,jo,new HashMap<>()
  ,"equipmentId","equipmentNo","manufacturerName","lockModelName","outStatus","corpName","bindStatus","guestRoomName");
            dataList.add(jo);
        }
  detail.put("dataList", dataList);

        detail.put(Consts.RESULT, ErrorCode.SUCCESS);
      return detail;
   }
```

queryGuestRoomList
queryDoorLockEquipmentList

insertGuestRoom

and de.equipment_no like  concat('%',#{equipmentNo,jdbcType=VARCHAR},'%')
